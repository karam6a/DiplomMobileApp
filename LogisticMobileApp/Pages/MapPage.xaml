<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:mapsui="clr-namespace:Mapsui.UI.Maui;assembly=Mapsui.UI.Maui"
             xmlns:helpers="clr-namespace:LogisticMobileApp.Helpers"
             x:Class="LogisticMobileApp.Pages.MapPage"
             Title="{Binding [Map_Title], Source={x:Static helpers:LocalizationResourceManager.Instance}}">

    <Grid x:Name="MainGrid">
        <!-- Карта Mapsui (на весь экран) -->
        <mapsui:MapControl x:Name="MapControl" />

        <!-- Индикатор загрузки -->
        <ActivityIndicator x:Name="LoadingIndicator"
                           IsRunning="False"
                           IsVisible="False"
                           Color="#1976D2"
                           VerticalOptions="Center"
                           HorizontalOptions="Center" />

        <!-- Список поворотов (плавающий над картой) -->
        <Border x:Name="TurnsListPanel"
                VerticalOptions="End"
                HorizontalOptions="End"
                Margin="70,0,10,200"
                StrokeShape="RoundRectangle 12"
                Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                StrokeThickness="1"
                BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1E1E1E}"
                IsVisible="False">
            <Border.Shadow>
                <Shadow Brush="Black" Offset="0,2" Radius="8" Opacity="0.3" />
            </Border.Shadow>
            <ScrollView MaximumHeightRequest="250">
                <VerticalStackLayout x:Name="TurnsListContainer"
                                     Padding="10"
                                     Spacing="8" />
            </ScrollView>
        </Border>
        
        <!-- Плавающая кнопка "Моё местоположение" -->
        <Border x:Name="MyLocationFloatingButton"
                VerticalOptions="End"
                HorizontalOptions="End"
                Margin="0,0,15,145"
                WidthRequest="56"
                HeightRequest="56"
                StrokeShape="RoundRectangle 28"
                StrokeThickness="0"
                BackgroundColor="#388E3C">
            <Border.Shadow>
                <Shadow Brush="Black" Offset="0,3" Radius="6" Opacity="0.35" />
            </Border.Shadow>
            <ImageButton Source="point_icon.svg"
                         BackgroundColor="Transparent"
                         WidthRequest="28"
                         HeightRequest="28"
                         HorizontalOptions="Center"
                         VerticalOptions="Center"
                         Clicked="OnMyLocationClicked" />
        </Border>

        <!-- Bottom Sheet -->
        <Border x:Name="BottomSheet"
                VerticalOptions="End"
                StrokeShape="RoundRectangle 20,20,0,0"
                Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#333333}"
                StrokeThickness="1"
                BackgroundColor="{AppThemeBinding Light=#FFFFFF, Dark=#1E1E1E}">
            
            <Border.Shadow>
                <Shadow Brush="Black" Offset="0,-2" Radius="10" Opacity="0.2" />
            </Border.Shadow>
            
            <Grid RowDefinitions="Auto,Auto,*">
                
                <!-- Ручка для свайпа (область для перетаскивания) -->
                <Grid x:Name="DragHandle" 
                      Grid.Row="0" 
                      Padding="0,8,0,5"
                      BackgroundColor="Transparent">
                    
                    <Grid.GestureRecognizers>
                        <PanGestureRecognizer PanUpdated="OnBottomSheetPanUpdated" />
                        <TapGestureRecognizer Tapped="OnDragHandleTapped" />
                    </Grid.GestureRecognizers>
                    
                    <VerticalStackLayout HorizontalOptions="Center" 
                                         VerticalOptions="Center"
                                         InputTransparent="True">
                        <BoxView WidthRequest="50" 
                                 HeightRequest="5" 
                                 CornerRadius="2.5"
                                 Color="{AppThemeBinding Light=#CCCCCC, Dark=#555555}"
                                 HorizontalOptions="Center" />
                        <Label x:Name="SwipeHintLabel"
                               Text="{Binding [Map_TapToExpand], Source={x:Static helpers:LocalizationResourceManager.Instance}}"
                               FontSize="12"
                               TextColor="{AppThemeBinding Light=#888888, Dark=#AAAAAA}"
                               HorizontalOptions="Center"
                               Margin="0,8,0,0" />
                    </VerticalStackLayout>
                </Grid>

                <!-- Кнопки управления (обычный режим) -->
                <HorizontalStackLayout x:Name="NormalButtonsPanel"
                                       Grid.Row="1" 
                                       Spacing="8" 
                                       Padding="10,5,10,15"
                                       HorizontalOptions="Center"
                                       IsVisible="True">
                    
                    <Button Text="{Binding [Map_CenterRoute], Source={x:Static helpers:LocalizationResourceManager.Instance}}"
                            BackgroundColor="#1976D2"
                            TextColor="White"
                            CornerRadius="8"
                            HeightRequest="44"
                            FontSize="13"
                            Padding="12,0"
                            Clicked="OnCenterRouteClicked" />

                    <Button Text="{Binding [Map_Navigate], Source={x:Static helpers:LocalizationResourceManager.Instance}}"
                            BackgroundColor="#FF5722"
                            TextColor="White"
                            CornerRadius="8"
                            HeightRequest="44"
                            FontSize="13"
                            Padding="12,0"
                            Clicked="OnNavigateClicked" />

                    <Button x:Name="FinishRouteButton"
                            Text="{Binding [Map_FinishRoute], Source={x:Static helpers:LocalizationResourceManager.Instance}}"
                            BackgroundColor="#4CAF50"
                            TextColor="White"
                            CornerRadius="8"
                            HeightRequest="44"
                            FontSize="13"
                            Padding="12,0"
                            IsEnabled="False"
                            Opacity="0.5"
                            Clicked="OnFinishRouteClicked" />
                </HorizontalStackLayout>
                
                <!-- Панель навигации (режим навигации) -->
                <Grid x:Name="NavigationPanel"
                      Grid.Row="1"
                      Padding="10,5,10,10"
                      RowDefinitions="Auto,Auto"
                      ColumnDefinitions="Auto,*"
                      ColumnSpacing="10"
                      RowSpacing="10"
                      IsVisible="False">
                    
                    <!-- Информация о точке назначения -->
                    <Border Grid.Row="0"
                            Grid.ColumnSpan="2"
                            StrokeShape="RoundRectangle 12"
                            Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                            StrokeThickness="1"
                            BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2A2A2A}"
                            Padding="12,10">
                        <Grid ColumnDefinitions="Auto,*,Auto,Auto" ColumnSpacing="10">
                            <!-- Иконка точки -->
                            <Border Grid.Column="0"
                                    WidthRequest="40"
                                    HeightRequest="40"
                                    StrokeShape="RoundRectangle 20"
                                    StrokeThickness="0"
                                    BackgroundColor="#4CAF50"
                                    VerticalOptions="Center">
                                <Label Text="1"
                                       TextColor="White"
                                       FontSize="18"
                                       FontAttributes="Bold"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center" />
                            </Border>
                            
                            <!-- Название и адрес точки -->
                            <VerticalStackLayout Grid.Column="1" 
                                                 VerticalOptions="Center"
                                                 Spacing="2">
                                <Label x:Name="DestinationNameLabel"
                                       Text=""
                                       FontSize="15"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light=#212121, Dark=#FFFFFF}"
                                       LineBreakMode="TailTruncation" />
                                <Label x:Name="DestinationAddressLabel"
                                       Text=""
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light=#757575, Dark=#AAAAAA}"
                                       LineBreakMode="TailTruncation" />
                            </VerticalStackLayout>
                            
                            <!-- Кнопка подтверждения -->
                            <Border Grid.Column="2"
                                    WidthRequest="44"
                                    HeightRequest="44"
                                    StrokeShape="RoundRectangle 10"
                                    StrokeThickness="0"
                                    BackgroundColor="#4CAF50"
                                    VerticalOptions="Center">
                                <ImageButton Source="confirm_pick_up_icon.svg"
                                             BackgroundColor="Transparent"
                                             WidthRequest="26"
                                             HeightRequest="26"
                                             HorizontalOptions="Center"
                                             VerticalOptions="Center"
                                             Clicked="OnConfirmPickUpClicked" />
                            </Border>
                            
                            <!-- Кнопка отказа -->
                            <Border Grid.Column="3"
                                    WidthRequest="44"
                                    HeightRequest="44"
                                    StrokeShape="RoundRectangle 10"
                                    StrokeThickness="0"
                                    BackgroundColor="#D32F2F"
                                    VerticalOptions="Center">
                                <ImageButton Source="denied_pick_up_icon.svg"
                                             BackgroundColor="Transparent"
                                             WidthRequest="26"
                                             HeightRequest="26"
                                             HorizontalOptions="Center"
                                             VerticalOptions="Center"
                                             Clicked="OnDeniedPickUpClicked" />
                            </Border>
                        </Grid>
                    </Border>
                    
                    <!-- Кнопка Назад -->
                    <Border Grid.Row="1"
                            Grid.Column="0"
                            StrokeShape="RoundRectangle 12"
                            StrokeThickness="0"
                            BackgroundColor="#757575"
                            WidthRequest="50"
                            HeightRequest="50"
                            VerticalOptions="Center">
                        <ImageButton x:Name="BackButton"
                                     Source="arrow_back.svg"
                                     BackgroundColor="Transparent"
                                     WidthRequest="30"
                                     HeightRequest="30"
                                     HorizontalOptions="Center"
                                     VerticalOptions="Center"
                                     Clicked="OnBackFromNavigationClicked" />
                    </Border>
                    
                    <!-- Информация о следующем повороте (кликабельная) -->
                    <Border x:Name="NavigationInfoBorder"
                            Grid.Row="1"
                            Grid.Column="1"
                                StrokeShape="RoundRectangle 12"
                                Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                                StrokeThickness="1"
                                BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2A2A2A}"
                                Padding="12,8">
                            <Border.GestureRecognizers>
                                <TapGestureRecognizer Tapped="OnNavigationInfoTapped" />
                            </Border.GestureRecognizers>
                            <Grid ColumnDefinitions="50,*,Auto" ColumnSpacing="10">
                                
                                <!-- Иконка направления -->
                                <Border Grid.Column="0"
                                        WidthRequest="46"
                                        HeightRequest="46"
                                        StrokeShape="RoundRectangle 23"
                                        StrokeThickness="0"
                                        BackgroundColor="#FF5722"
                                        VerticalOptions="Center"
                                        HorizontalOptions="Center">
                                    <Label x:Name="NavigationDirectionIcon"
                                           Text="→"
                                           TextColor="White"
                                           FontSize="24"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center" />
                                </Border>
                                
                                <!-- Текст инструкции -->
                                <VerticalStackLayout Grid.Column="1" 
                                                     VerticalOptions="Center"
                                                     Spacing="2">
                                    <Label x:Name="NavigationInstructionLabel"
                                           Text="Загрузка..."
                                           FontSize="14"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light=#212121, Dark=#FFFFFF}"
                                           LineBreakMode="TailTruncation"
                                           MaxLines="2" />
                                    <HorizontalStackLayout Spacing="8">
                                        <Label x:Name="NavigationDistanceLabel"
                                               Text=""
                                               FontSize="13"
                                               TextColor="#FF5722"
                                               FontAttributes="Bold" />
                                        <Label x:Name="NavigationStreetLabel"
                                               Text=""
                                               FontSize="12"
                                               TextColor="{AppThemeBinding Light=#757575, Dark=#AAAAAA}"
                                               LineBreakMode="TailTruncation" />
                                    </HorizontalStackLayout>
                                </VerticalStackLayout>
                                
                                <!-- Индикатор раскрытия -->
                                <Label x:Name="TurnsExpandIcon"
                                       Grid.Column="2"
                                       Text="▲"
                                       FontSize="12"
                                       TextColor="{AppThemeBinding Light=#888888, Dark=#AAAAAA}"
                                       VerticalOptions="Center" />
                            </Grid>
                        </Border>
                </Grid>

                <!-- Список точек маршрута -->
                <CollectionView x:Name="PointsCollectionView"
                                Grid.Row="2"
                                Margin="10,0,10,10"
                                SelectionMode="Single"
                                SelectionChanged="OnPointSelected">
                    <CollectionView.ItemTemplate>
                        <DataTemplate>
                            <Border Margin="0,4" 
                                    Padding="12,8" 
                                    StrokeShape="RoundRectangle 10"
                                    Stroke="{AppThemeBinding Light=#E0E0E0, Dark=#404040}"
                                    StrokeThickness="1"
                                    BackgroundColor="{AppThemeBinding Light=#F5F5F5, Dark=#2A2A2A}">
                                <Border.Triggers>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsConfirmed}" Value="True">
                                        <Setter Property="BackgroundColor" Value="#C8E6C9" />
                                        <Setter Property="Stroke" Value="#2E7D32" />
                                        <Setter Property="StrokeThickness" Value="2" />
                                    </DataTrigger>
                                    <DataTrigger TargetType="Border" Binding="{Binding IsRejected}" Value="True">
                                        <Setter Property="BackgroundColor" Value="#FFCDD2" />
                                        <Setter Property="Stroke" Value="#C62828" />
                                        <Setter Property="StrokeThickness" Value="2" />
                                    </DataTrigger>
                                </Border.Triggers>
                                <Grid ColumnDefinitions="40,*,Auto,Auto,Auto" ColumnSpacing="6">
                                    <!-- Номер точки -->
                                    <Border Grid.Column="0"
                                            WidthRequest="36"
                                            HeightRequest="36"
                                            StrokeShape="RoundRectangle 18"
                                            StrokeThickness="0"
                                            BackgroundColor="{Binding StatusColor}"
                                            VerticalOptions="Center">
                                        <Label Text="{Binding Index}"
                                               TextColor="White"
                                               FontAttributes="Bold"
                                               FontSize="16"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Center" />
                                    </Border>
                                    
                                    <!-- Информация о клиенте -->
                                    <VerticalStackLayout Grid.Column="1" 
                                                         Spacing="2"
                                                         Padding="4,0,0,0"
                                                         VerticalOptions="Center">
                                        <Label Text="{Binding Name}"
                                               FontAttributes="Bold"
                                               FontSize="14"
                                               TextColor="{AppThemeBinding Light=#212121, Dark=#FFFFFF}"
                                               LineBreakMode="TailTruncation" />
                                        <Label Text="{Binding Address}"
                                               FontSize="12"
                                               TextColor="{AppThemeBinding Light=#757575, Dark=#AAAAAA}"
                                               LineBreakMode="TailTruncation" />
                                    </VerticalStackLayout>
                                    
                                    <!-- Кнопка подтверждения -->
                                    <Border Grid.Column="2"
                                            WidthRequest="38"
                                            HeightRequest="38"
                                            StrokeShape="RoundRectangle 8"
                                            StrokeThickness="0"
                                            BackgroundColor="#4CAF50"
                                            VerticalOptions="Center"
                                            IsVisible="{Binding IsNotProcessed}">
                                        <ImageButton Source="confirm_pick_up_icon.svg"
                                                     BackgroundColor="Transparent"
                                                     WidthRequest="22"
                                                     HeightRequest="22"
                                                     HorizontalOptions="Center"
                                                     VerticalOptions="Center"
                                                     CommandParameter="{Binding .}"
                                                     Clicked="OnListItemConfirmClicked" />
                                    </Border>
                                    
                                    <!-- Кнопка отказа -->
                                    <Border Grid.Column="3"
                                            WidthRequest="38"
                                            HeightRequest="38"
                                            StrokeShape="RoundRectangle 8"
                                            StrokeThickness="0"
                                            BackgroundColor="#D32F2F"
                                            VerticalOptions="Center"
                                            IsVisible="{Binding IsNotProcessed}">
                                        <ImageButton Source="denied_pick_up_icon.svg"
                                                     BackgroundColor="Transparent"
                                                     WidthRequest="22"
                                                     HeightRequest="22"
                                                     HorizontalOptions="Center"
                                                     VerticalOptions="Center"
                                                     CommandParameter="{Binding .}"
                                                     Clicked="OnListItemDeniedClicked" />
                                    </Border>
                                    
                                    <!-- Иконка статуса (для обработанных) -->
                                    <Label Grid.Column="4"
                                           VerticalOptions="Center"
                                           FontSize="20"
                                           Margin="4,0,0,0"
                                           IsVisible="{Binding IsProcessed}">
                                        <Label.Triggers>
                                            <DataTrigger TargetType="Label" Binding="{Binding IsConfirmed}" Value="True">
                                                <Setter Property="Text" Value="✓" />
                                                <Setter Property="TextColor" Value="#2E7D32" />
                                            </DataTrigger>
                                            <DataTrigger TargetType="Label" Binding="{Binding IsRejected}" Value="True">
                                                <Setter Property="Text" Value="✗" />
                                                <Setter Property="TextColor" Value="#C62828" />
                                            </DataTrigger>
                                        </Label.Triggers>
                                    </Label>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </CollectionView.ItemTemplate>
                </CollectionView>
            </Grid>
        </Border>
    </Grid>
</ContentPage>
